<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EmailChat – Minimal Frontend</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; }
    .row { margin: 8px 0; }
    textarea, input { padding: 6px; }
    pre { background:#111; color:#eee; padding:12px; overflow:auto; }
    .col { display:inline-block; vertical-align:top; width:48%; }
    button { cursor: pointer; }
    .muted { color:#666; }
    .ok { color: #0a6; }
    .err { color: #b00; }
  </style>
</head>
<body>
  <h2>Minimal Frontend (inside chat app)</h2>

  <!-- Login -->
  <div class="row">
    <strong>Login (token):</strong><br/>
    <input id="username" placeholder="username" />
    <input id="password" type="password" placeholder="password" />
    <button id="btnLogin">Get Token</button>
    <button id="btnLogout" class="muted">Logout</button>
    <span id="loginStatus" class="muted"></span>
  </div>

  <hr/>

  <!-- Chats -->
  <div class="row">
    <button id="btnLoadChats">Load Chats</button>
    <div id="chats" class="muted">Chats: 0</div>
  </div>

  <hr/>

  <!-- Invite -->
  <div class="row">
    <h3>Invite a friend by email</h3>
    <input id="inviteEmail" type="email" placeholder="friend@example.com" />
    <button id="btnInvite">Send Invite</button>
    <span id="inviteStatus" class="muted"></span>
  </div>

  <!-- Create Message + WebSocket -->
  <div class="row">
    <div class="col">
      <h3>Send Message (saves via REST)</h3>
      <div>Chat ID: <input id="chatId" value="1" size="6" /></div>
      <div>Sender (user id): <input id="senderId" value="1" size="6" /></div>
      <div>Content:</div>
      <textarea id="content" rows="3" cols="40"></textarea><br/>
      <button id="btnSend">POST /api/messages/</button>
      <div id="sendStatus" class="muted"></div>
    </div>

    <div class="col">
      <h3>Live Chat (WebSocket)</h3>
      <div>WS Chat ID: <input id="wsChatId" value="1" size="6" /></div>
      <button id="btnConnectWs">Connect WS</button>
      <button id="btnCloseWs">Close WS</button>
      <div>Outgoing text:</div>
      <input id="wsText" placeholder="hello via ws" />
      <button id="btnWsSend">Send over WS</button>
      <pre id="wsLog"></pre>
    </div>
  </div>

  <hr/>
  <h3>Raw Responses</h3>
  <pre id="raw"></pre>

<script>
/* ---------------- Config ---------------- */
const API = location.origin;                       // e.g., https://your-app.onrender.com
const TOKEN_ENDPOINTS = ["/api/auth/token/", "/api-token-auth/"]; // tries first, then fallback
const INVITE_API_PATH = "/api/invite/";            // POST {email}
const MESSAGES_API_PATH = "/api/messages/";        // POST {chat, sender, content}
const CHATS_API_PATH = "/api/chats/";              // GET list
const WS_PATH_PREFIX = "/ws/chat/";                // /ws/chat/<chat_id>/

/* ---------------- Auth state ---------------- */
let TOKEN = localStorage.getItem('token') || '';
let sock = null;

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);

function setToken(t) {
  TOKEN = t || '';
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
  $('loginStatus').textContent = TOKEN ? '✓ token stored' : '';
}

function getCookie(name) {
  const parts = document.cookie.split(';').map(c => c.trim());
  for (const c of parts) {
    if (c.startsWith(name + '=')) return decodeURIComponent(c.slice(name.length + 1));
  }
  return null;
}

function showRaw(obj) {
  $('raw').textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
}

function setStatus(el, ok, msg) {
  el.classList.remove('ok', 'err', 'muted');
  el.classList.add(ok ? 'ok' : 'err');
  el.textContent = msg;
}

function wsScheme(){ return (location.protocol === 'https:') ? 'wss' : 'ws'; }

/* Generic fetch that auto-applies Token if present, else CSRF for same-origin */
async function apiFetch(path, opts = {}) {
  const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
  if (TOKEN) {
    headers['Authorization'] = `Token ${TOKEN}`;
  } else {
    // session auth with CSRF (if you're logged into /admin)
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;
  }
  const res = await fetch(`${API}${path}`, Object.assign({}, opts, { headers }));
  let data = null;
  try { data = await res.json(); } catch {}
  return { res, data };
}

/* ---------------- Login (Token) ---------------- */
async function login() {
  const username = $('username').value.trim();
  const password = $('password').value;

  let lastErr = null;
  for (const ep of TOKEN_ENDPOINTS) {
    try {
      const { res, data } = await apiFetch(ep, {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      showRaw(data || res.statusText);
      if (res.ok && data && (data.token || data.key)) {
        setToken(data.token || data.key);
        return;
      }
    } catch (e) { lastErr = e; }
  }
  setToken('');
  alert('Login failed (token endpoint).');
}

function logout() {
  setToken('');
  showRaw('Logged out, token cleared.');
}

/* ---------------- REST: list chats & send message ---------------- */
async function loadChats() {
  const { res, data } = await apiFetch(CHATS_API_PATH, { method: 'GET' });
  showRaw(data || res.statusText);
  $('chats').textContent = `Chats: ${Array.isArray(data) ? data.length : 0}`;
  if (res.status === 403) alert('Forbidden: login first (token or admin session).');
}

async function sendMessage() {
  const chat = parseInt($('chatId').value, 10);
  const sender = parseInt($('senderId').value, 10);
  const content = $('content').value;

  const { res, data } = await apiFetch(MESSAGES_API_PATH, {
    method: 'POST',
    body: JSON.stringify({ chat, sender, content })
  });

  showRaw(data || res.statusText);
  setStatus($('sendStatus'), res.ok, res.ok ? '✓ saved' : '✗ error');
}

/* ---------------- WebSocket ---------------- */
function logWs(msg) {
  const el = $('wsLog');
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
}

function connectWs() {
  const id = $('wsChatId').value.trim();
  if (!id) return alert('Enter WS Chat ID (or use the magic link with ?chat_id=...)');
  if (sock && sock.readyState === WebSocket.OPEN) sock.close();

  const url = `${wsScheme()}://${location.host}${WS_PATH_PREFIX}${encodeURIComponent(id)}/`;
  sock = new WebSocket(url);
  sock.onopen = () => logWs('WS: connected');
  sock.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      logWs('WS ← ' + (data.message ?? e.data));
    } catch {
      logWs('WS ← ' + e.data);
    }
  };
  sock.onclose = () => logWs('WS: closed');
  sock.onerror = () => logWs('WS: error');
}

function closeWs() {
  if (sock) { sock.close(); sock = null; }
}

function wsSend() {
  if (!sock || sock.readyState !== 1) return alert('WS not connected');
  const text = $('wsText').value;
  // Most consumers expect {"message": "..."}; adjust if your consumer needs more
  sock.send(JSON.stringify({ message: text }));
  logWs('WS → ' + text);
  $('wsText').value = '';
}

/* ---------------- Invite ---------------- */
async function sendInvite() {
  const email = $('inviteEmail').value.trim();
  if (!email) return;

  const { res, data } = await apiFetch(INVITE_API_PATH, {
    method: 'POST',
    body: JSON.stringify({ email })
  });

  showRaw(data || res.statusText);
  setStatus($('inviteStatus'), res.ok,
    res.ok ? '✓ sent! Ask your friend to check email.' :
             ('✗ error' + (data?.detail ? ': ' + data.detail : '')));
}

/* ---------------- Wire up buttons ---------------- */
$('btnLogin').onclick = login;
$('btnLogout').onclick = logout;
$('btnLoadChats').onclick = loadChats;
$('btnSend').onclick = sendMessage;
$('btnConnectWs').onclick = connectWs;
$('btnCloseWs').onclick = closeWs;
$('btnWsSend').onclick = wsSend;
$('btnInvite').onclick = sendInvite;

/* ---------------- Initial state ---------------- */
if (TOKEN) $('loginStatus').textContent = '✓ token loaded';

// Prefill chat id from ?chat_id=... (after magic-link redirect)
const params = new URLSearchParams(location.search);
if (params.get('chat_id')) {
  const cid = params.get('chat_id');
  $('wsChatId').value = cid;
  $('chatId').value = cid;
}
</script>
</body>
</html>
